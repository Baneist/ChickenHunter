# ChickenHunter 项目文档

> 同济大学软件工程荣誉课2021年高级程序设计课程期末大项目

## 项目信息

- 项目中文名：**鸡地求生**
- 项目英文名：**ChickenHunter**
- 项目成员：
  - 成笑行 2053302
  - 王钧涛 2050254
  - 何懿励 2050255
- 小组成员贡献比例

| 姓名   | 分工                                                         | 贡献比例 |
| :----- | ------------------------------------------------------------ | -------- |
| 成笑行 | 框架搭建，界面绘制，素材收集，武器系统，适配安卓端，地图绘制 | 100%     |
| 王钧涛 | 实现联网功能（服务器、客户端），地图绘制                     | 100%     |
| 何懿励 | 交互设计，动画动作，敌人AI，物品系统，武器系统，项目文档     | 100%     |

- 项目Github地址： <https://github.com/vozeo/ChickenHunter>
- 项目进度时间线
  - 2021-05-04
    - 学习cocos2dx
  - 2021-05-19
    - 添加人物和地图
  - 2021-05-22
    - 添加人物动画与动作
  - 2021-05-23
    - 添加人物状态层
  - 2021-05-26
    - 添加地图障碍层
  - 2021-06-06
    - 添加子弹
    - 添加武器
  - 2021-06-07
    - 切换武器
    - 安卓端设计，增加触摸与键盘功能
  - 2021-06-08
    - 设计并添加物品类
    - 拾起物品
    - 添加音效
  - 2021-06-10
    - 添加敌人AI
  - 2021-06-11
    - 添加yasio库与联网功能
    - 添加退出界面和音量调节功能
  - 2021-06-12
    - 使yasio适配安卓端
    - 添加服务器移动
    - 增加受伤特效
    - 添加房间功能
    - 添加游戏结算与排行榜功能
  - 2021-06-14
    - 设计武器属性
    - 添加散射攻击效果
    - 添加服务器按键回传
    - 添加开局bonus抽选功能
  - 2021-06-15
    - 完成联网地图位置同步
    - 增加设置按钮
  - 2021-06-16
    - 添加安卓端多点触摸功能
    - 绘制新地图
    - 添加联机武器系统
    - 添加手榴弹武器和粒子特效
  - 2021-06-17
    - 添加安卓端联机自动拾取功能
  - 2021-06-18
    - 添加武器：手榴弹
    - 撰写项目文档
  - 2021-06-19
    - 添加服务器敌人AI
    - 添加多人模式聊天系统



## 项目开发文档

- 选用引擎：**Cocos2d-x 4.0**
- 辅助软件：Tiled Map Editor、Adobe Photoshop CC、TexturePackerGUI
- 支持平台：Windows，Android
- 小组分工

|  姓名  |                             分工                             | 贡献比例 |
| :-----: | :----------------------------------------------: | :-------: |
| 成笑行 | 框架搭建，界面绘制，素材收集，武器系统，适配安卓端，地图绘制 |   100%   |
| 王钧涛 |           实现联网功能（服务器、客户端），地图绘制           |   100%   |
| 何懿励 |   交互设计，动画动作，敌人AI，物品系统，武器系统，项目文档   |   100%   |

- **实现的功能点及实现思路**

  - 基础功能
    - [x] 游戏开始界面、背景音乐、退出功能、计时系统、障碍物边界
    - [x] 联网功能：创建和加入房间，添加AI与其他玩家
      - 使用了第三方yasio库实现跨平台的基础的网络连接以及包传输事件
      - 服务端每秒向客户端发送房间连接信息
      - 在人物交互模块中采集本地动作信息并上传至主机
      - 主机进行人物数据的处理和帧渲染，然后将地图数据回传给客户端显示
    - [x] 键盘控制人物走动、翻滚，鼠标控制人物射击与射击方向
      - 使用registerTouchEvent()与registerKeyboardEvent()监视鼠标与键盘的操作
      - 在update()函数中控制人物移动，在自定义schedule中实现定时发射子弹
      - w/a/s/d移动方向，单击或长按鼠标左键射击，空格键翻滚
    - [x] 支持武器、弹药掉落和拾取
      - 玩家行走到道具位置，按下E键拾取
      - AI每一帧判断是否在当前位置有道具可拾取，自动拾取
      - 拾取weapon时先retain，再从地图上移除weapon，将其存入hunter武器库
      - 拾取弹药箱和医疗包时从地图上移除，并即时为人物增加弹药量和血量
    - [x] 支持积分系统（排行榜）
      - 玩家胜利或死亡后出现结算界面，按照人物积分顺序进行排序
  
  - 可选功能
    - [x] 游戏设置
      - 音量设置：使用slider控件滑动按钮，获取音量值并使用AudioEngine设置音量
      - 可开启或关闭外挂、瞄准辅助线
      
    - [x] bonus机制（开局随机抽取）
      - 提升人物125%的攻击力
      - 提升血量上限至120
      - 提升防御力使血量减少值为原来的0.8倍
      - 提升子弹攻速为每发间隔0.26s
      
    - [x] 多类AI
      - 四种枪械武器AI（与人物武器数量相同）
      - 近战AI
      - 轰炸AI（手榴弹）
      
    - [x] 瞄准线
      - 跟随光标移动的瞄准线，便于瞄准敌人
      
    - [x] 外挂
      - 锁定血量始终满血
      - 锁定子弹数量无限
      - 自动瞄准射击：将人物与AI系统相结合，进行自动瞄准射击
      
    - [x] 聊天系统
      - 同一房间内玩家可以自由聊天
      - 有新未读聊天会有红点提示



- <font color='red'>**项目的技术难点及解决过程**</font>

  - 动态拾取武器更新状态
    - 使用Menu与MenuItem，捡拾武器后重新生成武器列表，实现动态拾取的效果。
  - 联网系统
    - 服务端
    - 客户端
    
    - 人物的移动和射击
    
    - 聊天系统
  - Android端适配和摇杆
    - 使用新版gradle编译和多点触摸EventListenerTouchAllAtOnce进行开发。
  - 坐标转换
    - 整个游戏涉及以地图为原点的场景坐标、以屏幕右下角为原点的控制坐标、以屏幕中心为原点的武器坐标、以屏幕左上角为原点的OpenGL坐标等多种坐标，通过计算，编写出一套坐标换算体系，实现游戏效果的统一。
  - 内存管理
    - cocos2dx的类使用单独的引用计数，导致类内部无法定义静态变量。早期调试过程中也因为对cocos2dx内存管理理解不够透彻，导致了很多严重的bug，比如忘记使用retain和release等不同的bug。通过学习内存管理体系，解决了内存泄漏、读取空指针等bug。



- **创新点/亮点**
  - 联网
    - 虽然联网是在基础要求中的，但是却比许多额外功能更复杂。框架的选取我们没有用常见的socket而是用了开源框架 yasio。通过仔细研读样例和API说明，我们自己编写了客户端、服务器，修改了大量原有的代码。这一个功能占了所有工作量中巨大的比例。
    - 与联网相关的联网外挂、聊天系统也是工作量比较大的点。
  
  - 适配多平台运行
    - 项目刚开始决定采用纯英文界面和编码，防止因中文编码问题导致的跨平台编译失败。
    - Android端更新了 cocos 自带的 gradle 和 gradle plugin ，防止因为版本问题产生编译失败。
    - 重新适配和调整了 cmakelist 文件，并选取支持多平台的yasio作为网络模块。
    - 理论上在 Linux 系统也能正常运行。IOS 端由于开发者账号和系统问题未作适配，如果有账号和系统能在短时间内正常运行。
  - 移动端可使用手柄进行游戏
    - 使用了多点触摸 EventListenerTouchAllAtOnce 进行开发，重新编写了控制界面，使用双摇杆进行控制。
    - 判断触摸位置来调整人物的移动和射击。
    - 手榴弹的释放做了实时显示攻击范围的动画。
  - 手榴弹武器
    - 使用方法：预估敌人的位置并点击该位置。前摇为在此位置投射爆炸范围圆圈，0.5s 后手榴弹爆炸，范围内敌人根据离爆炸中心的距离受到不同程度的伤害
    - 使用粒子系统中的 ParticleExplosion 完成爆炸动画
  - 散射枪
    - 可以在地图中拾取散射枪，一次射出3发子弹，每一发子弹的方向相差 atan(0.15) 度
  - 图集的使用
    - 使用 TexturePackerGUI 将动画和图像资源打包生成图集与 .plist 文件，并将图集全部加载到缓存中 ，创建动画时读取缓存即可，提高了性能。



- **加分项**
  - 版本控制与团队合作
    - [x] commit历史干净规范，commit 描述规范
    - [x] 使用分支进行团队协作
    - [x] 团队成员分工平等、合理
    - [x] 全程使用 GitHub 和 Git 进行版本控制
  - 代码质量与安全<font color='red'>（添加描述）</font>
    - [x] 合理的异常抛出与处理
    - [x] 使用断言验证程序性质
  - 功能与架构
    - [x] 界面精致
    - [x] 能直接在Android平台运行
    - [x] 项目目录结构良好、清晰
  - 使用C++11或更高的C++新特性
    - [x] 初始化列表
    - [x] 类型推断（auto、decltype）
    - [x] 基于范围的 for 循环
    - [x] 常量表达式（constexpr）
    - [x] Lambda 函数
    - [x] std::function
    - [x] default 构造函数
    - [x] nullptr 初始化空指针



- **项目运行截图**

![GameScene](ProjectPictuires\GameScene1.png)

![GameScene](ProjectPictuires\GameScene2.png)

![GameScene](ProjectPictuires\GameScene3.jpg)

![GameScene](ProjectPictuires\GameScene4.jpg)

